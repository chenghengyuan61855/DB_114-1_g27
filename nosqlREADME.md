# NoSQL é£²æ–™é»æ“Šåˆ†æç³»çµ± - ä½¿ç”¨èªªæ˜

## ğŸ“Š ç³»çµ±æ¦‚è¿°

æ­¤ç³»çµ±ä½¿ç”¨ MongoDB è¨˜éŒ„ä½¿ç”¨è€…çš„é£²æ–™é»æ“Šè¡Œç‚ºï¼Œä¸¦æä¾›å“ç‰Œç®¡ç†è€…åˆ†æå·¥å…·ï¼ŒåŒ…å«ï¼š

1. **å•†å“è§¸åŠæ¬¡æ•¸çµ±è¨ˆ** - æœ‰å¤šå°‘äººçœ‹é/é»æ“Šéè©²å•†å“
2. **åæ‚”ç‡åˆ†æ** - é»äº†ä½†æœ€çµ‚æ²’æœ‰ä¸‹å–®çš„æ¯”ä¾‹
3. **ç†±é–€å•†å“æ’è¡Œ** - æœ€å—æ­¡è¿çš„å•†å“
4. **è½‰æ›ç‡çµ±è¨ˆ** - é»æ“Šåˆ°ä¸‹å–®çš„è½‰æ›æ•ˆç‡
5. **ç†±é–€æ™‚æ®µåˆ†æ** - å“ªäº›æ™‚æ®µæœ€å¤šäººä¸‹å–®

---

## ğŸ”§ æŠ€è¡“æ¶æ§‹

### è³‡æ–™æµç¨‹

```
ä½¿ç”¨è€…é¸æ“‡å•†å“
    â†“
log_drink_click() â†’ MongoDB (submitted=False)
    â†“
ä½¿ç”¨è€…å®Œæˆä¸‹å–®ï¼Ÿ
    â†™          â†˜
   æ˜¯          å¦
    â†“          â†“
mark_as_submitted()  ä¿æŒ submitted=False
    â†“                    â†“
MongoDB (submitted=True)  (ä»£è¡¨åæ‚”)
```

### æª”æ¡ˆçµæ§‹

```
db/
â”œâ”€â”€ nosql.py                    # MongoDB é€£ç·šè¨­å®š
â”œâ”€â”€ nosql_logger.py             # è¨˜éŒ„é»æ“Š & æ¨™è¨˜è¨‚å–®
â””â”€â”€ nosql_analytics.py          # åˆ†ææŸ¥è©¢å‡½æ•¸

ui/
â””â”€â”€ analytics/
    â””â”€â”€ click_analytics.py      # å“ç‰Œç®¡ç†è€…åˆ†æä»‹é¢

menu/
â””â”€â”€ brand_manager_menu.py       # æ•´åˆåˆ†æåŠŸèƒ½åˆ°é¸å–®
```

---

## ğŸ“¥ å®‰è£èˆ‡è¨­å®š

### 1. å®‰è£ MongoDBï¼ˆæœ¬åœ°é–‹ç™¼ï¼‰

```bash
# macOS
brew install mongodb-community

# Ubuntu/Debian
sudo apt install mongodb

# Windows
# å¾å®˜ç¶²ä¸‹è¼‰å®‰è£ï¼šhttps://www.mongodb.com/try/download/community
```

### 2. å®‰è£ Python å¥—ä»¶

```bash
pip install pymongo
```

### 3. å•Ÿå‹• MongoDB

```bash
# å•Ÿå‹• MongoDB æœå‹™
mongod --dbpath /path/to/data

# æˆ–ä½¿ç”¨ç³»çµ±æœå‹™
sudo systemctl start mongodb  # Linux
brew services start mongodb-community  # macOS
```

### 4. é©—è­‰é€£ç·š

```python
from db.nosql import drink_clicks

# æ¸¬è©¦é€£ç·š
print(drink_clicks.count_documents({}))  # æ‡‰è©²è¿”å›æ•¸å­—ï¼ˆå¯èƒ½æ˜¯ 0ï¼‰
```

---

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### å°æ–¼é–‹ç™¼è€…

#### 1. è¨˜éŒ„é£²æ–™é»æ“Šï¼ˆå·²å¯¦ä½œï¼‰

åœ¨ `ui/order/select_product.py` ä¸­å·²è‡ªå‹•è¨˜éŒ„ï¼š

```python
from db.nosql_logger import log_drink_click

# ç•¶ä½¿ç”¨è€…é¸æ“‡å•†å“æ™‚
log_drink_click(user_id, brand_id, product_id)
```

#### 2. æ¨™è¨˜è¨‚å–®é€å‡ºï¼ˆéœ€æ•´åˆï¼‰

åœ¨ `ui/order/confirm_order.py` çš„è¨‚å–®æˆåŠŸå¾ŒåŠ å…¥ï¼š

```python
from db.nosql_logger import mark_drink_as_submitted
from db.store.manage import db_fetch_store_info

# è¨‚å–®æˆåŠŸå¾Œ
store_info = db_fetch_store_info(store_id)
brand_id = store_info['brand_id']

for item in selected_items:
    mark_drink_as_submitted(
        user_id=user_id,
        brand_id=brand_id,
        product_id=item['product_id'],
        order_id=actual_order_id
    )
```

### å°æ–¼å“ç‰Œç®¡ç†è€…

#### ç™»å…¥å¾Œé¸æ“‡ã€Œ12. é£²æ–™é»æ“Šåˆ†æã€

```
=== é£²æ–™é»æ“Šåˆ†æ ===

1. æŸ¥çœ‹å•†å“é»æ“Šçµ±è¨ˆ
   â†’ é¡¯ç¤ºæ‰€æœ‰å•†å“çš„é»æ“Šæ¬¡æ•¸ã€å®Œæˆè¨‚å–®æ•¸ã€åæ‚”ç‡

2. æŸ¥çœ‹ç†±é–€å•†å“ TOP 10
   â†’ æ‰¾å‡ºæœ€å—æ­¡è¿çš„å•†å“

3. æŸ¥çœ‹é«˜åæ‚”ç‡å•†å“
   â†’ æ‰¾å‡ºé»äº†ä½†æ²’è²·çš„å•†å“ï¼ˆå¯èƒ½æœ‰å®šåƒ¹æˆ–æè¿°å•é¡Œï¼‰

4. æŸ¥çœ‹æ•´é«”è½‰æ›ç‡
   â†’ äº†è§£å“ç‰Œçš„æ•´é«”ä¸‹å–®æ•ˆç‡

5. æŸ¥çœ‹ç†±é–€æ™‚æ®µåˆ†æ
   â†’ æ‰¾å‡ºä»€éº¼æ™‚å€™æœ€å¤šäººä¸‹å–®
```

---

## ğŸ“ˆ åˆ†ææŒ‡æ¨™èªªæ˜

### 1. é»æ“Šæ¬¡æ•¸ï¼ˆTotal Clicksï¼‰
- **å®šç¾©**ï¼šä½¿ç”¨è€…åœ¨é¸å•†å“ä»‹é¢çœ‹åˆ°ä¸¦é»é¸è©²å•†å“çš„æ¬¡æ•¸
- **ç”¨é€”**ï¼šäº†è§£å•†å“æ›å…‰æ•ˆæœã€å¸å¼•åŠ›
- **é«˜é»æ“Šä½†ä½è½‰æ›** â†’ å¯èƒ½å®šåƒ¹éé«˜æˆ–æè¿°ä¸æ¸…

### 2. å®Œæˆè¨‚å–®æ•¸ï¼ˆSubmitted Countï¼‰
- **å®šç¾©**ï¼šæœ€çµ‚çœŸçš„ä¸‹å–®è³¼è²·çš„æ¬¡æ•¸
- **ç”¨é€”**ï¼šçœŸå¯¦éŠ·å”®æ•¸æ“š

### 3. åæ‚”ç‡ï¼ˆAbandon Rateï¼‰
- **è¨ˆç®—**ï¼š`(ç¸½é»æ“Š - å®Œæˆè¨‚å–®) / ç¸½é»æ“Š Ã— 100%`
- **ç”¨é€”**ï¼š
  - **< 30%**ï¼šæ­£å¸¸ç¯„åœ
  - **30-50%**ï¼šéœ€è¦é—œæ³¨
  - **> 50%**ï¼šåš´é‡å•é¡Œï¼Œå»ºè­°æª¢æŸ¥å®šåƒ¹ã€æè¿°ã€é¸é …è¨­å®š

### 4. è½‰æ›ç‡ï¼ˆConversion Rateï¼‰
- **è¨ˆç®—**ï¼š`å®Œæˆè¨‚å–® / ç¸½é»æ“Š Ã— 100%`
- **ç”¨é€”**ï¼šè¡¡é‡å“ç‰Œæ•´é«”éŠ·å”®æ•ˆç‡
- **åŸºæº–**ï¼š
  - **> 70%**ï¼šå„ªç§€
  - **50-70%**ï¼šè‰¯å¥½
  - **30-50%**ï¼šéœ€æ”¹é€²
  - **< 30%**ï¼šè­¦å‘Šï¼ˆæª¢æŸ¥æµç¨‹æ˜¯å¦å¤ªè¤‡é›œï¼‰

### 5. ç†±é–€æ™‚æ®µï¼ˆHourly Distributionï¼‰
- **å®šç¾©**ï¼šæ¯å°æ™‚çš„é»æ“Šæ¬¡æ•¸åˆ†å¸ƒ
- **ç”¨é€”**ï¼š
  - å®‰æ’äººåŠ›ï¼ˆç†±é–€æ™‚æ®µå¢åŠ äººæ‰‹ï¼‰
  - æ¨å‡ºé™æ™‚å„ªæƒ ï¼ˆåœ¨ç†±é–€æ™‚æ®µå¸å¼•æ›´å¤šè¨‚å–®ï¼‰
  - åº«å­˜ç®¡ç†ï¼ˆç†±é–€æ™‚æ®µå‰è£œè²¨ï¼‰

---

## ğŸ› ï¸ ç¶­è­·èˆ‡å„ªåŒ–

### å®šæœŸæ¸…ç†èˆŠè³‡æ–™

å»ºè­°æ¯å­£åŸ·è¡Œä¸€æ¬¡ï¼š

```python
from db.nosql_analytics import clean_old_records

# åˆªé™¤ 90 å¤©å‰çš„è³‡æ–™
deleted_count = clean_old_records(days=90)
print(f"å·²åˆªé™¤ {deleted_count} ç­†èˆŠè¨˜éŒ„")
```

### å»ºç«‹ç´¢å¼•ï¼ˆæå‡æŸ¥è©¢é€Ÿåº¦ï¼‰

```python
from db.nosql import drink_clicks

# ç‚ºå¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•
drink_clicks.create_index([("brand_id", 1), ("timestamp", -1)])
drink_clicks.create_index([("product_id", 1)])
drink_clicks.create_index([("user_id", 1)])
```

### å‚™ä»½è³‡æ–™

```bash
# å‚™ä»½ MongoDB è³‡æ–™åº«
mongodump --db nosql_database --out /path/to/backup

# é‚„åŸ
mongorestore --db nosql_database /path/to/backup/nosql_database
```

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: MongoDB é€£ç·šå¤±æ•—

**è§£æ±ºæ–¹æ³•**ï¼š
1. ç¢ºèª MongoDB æœå‹™å·²å•Ÿå‹•
2. æª¢æŸ¥ `db/nosql.py` ä¸­çš„é€£ç·šå­—ä¸²
3. ç¢ºèªé˜²ç«ç‰†è¨­å®š

### Q2: è³‡æ–™æ²’æœ‰è¨˜éŒ„

**æª¢æŸ¥é …ç›®**ï¼š
1. `log_drink_click()` æ˜¯å¦è¢«æ­£ç¢ºå‘¼å«
2. MongoDB æ˜¯å¦æœ‰å¯«å…¥æ¬Šé™
3. æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯ï¼ˆå·²åŠ å…¥ try-exceptï¼‰

### Q3: åˆ†ææ•¸æ“šä¸æº–ç¢º

**å¯èƒ½åŸå› **ï¼š
1. æ²’æœ‰å‘¼å« `mark_drink_as_submitted()`
2. brand_id å‚³å…¥éŒ¯èª¤
3. æ™‚é–“ç¯„åœè¨­å®šå•é¡Œ

---

## ğŸš€ é€²éšåŠŸèƒ½å»ºè­°

### 1. å•†å“æ¨è–¦ç³»çµ±
```python
# åŸºæ–¼é»æ“Šè¡Œç‚ºæ¨è–¦ç›¸ä¼¼å•†å“
def get_similar_products(user_id):
    # æ‰¾å‡ºè©²ä½¿ç”¨è€…é»éçš„å•†å“
    # æ‰¾å‡ºå…¶ä»–ä½¿ç”¨è€…ä¹Ÿé»éé€™äº›å•†å“çš„äºº
    # æ¨è–¦ä»–å€‘é‚„é»éçš„å…¶ä»–å•†å“
```

### 2. A/B æ¸¬è©¦
```python
# æ¸¬è©¦ä¸åŒå®šåƒ¹æˆ–æè¿°å°è½‰æ›ç‡çš„å½±éŸ¿
def track_ab_test(product_id, variant):
    # variant = "A" or "B"
```

### 3. ä½¿ç”¨è€…åˆ†ç¾¤
```python
# æ ¹æ“šé»æ“Šè¡Œç‚ºåˆ†ç¾¤
# - é«˜åæ‚”ä½¿ç”¨è€…ï¼ˆéœ€è¦å„ªæƒ å¸å¼•ï¼‰
# - å¿ å¯¦å®¢æˆ¶ï¼ˆç¶“å¸¸ä¸‹å–®ï¼‰
# - ç€è¦½å‹ä½¿ç”¨è€…ï¼ˆçœ‹å¾ˆå¤šä½†ä¸è²·ï¼‰
```

---

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠæˆ–åƒè€ƒï¼š
- MongoDB å®˜æ–¹æ–‡æª”ï¼šhttps://docs.mongodb.com/
- PyMongo æ–‡æª”ï¼šhttps://pymongo.readthedocs.io/

---

**æœ€å¾Œæ›´æ–°ï¼š2025-12-08**
