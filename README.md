# 114-1 資料庫管理 - DaTEAbase 專案

## 專案簡介

在經營手搖飲品牌的路上，最讓人頭痛的，從來不是「茶要不要加冰」，而是系統各自為政、資料七零八落、訂單和庫存永遠對不起來。如果你也有這些困擾，就來認識 daTEAbase 吧。

daTEAbase 是一個專為手搖飲與連鎖餐飲打造的營運管理平台，支援「多品牌、多門市」的集團式架構、商品客製化、即時庫存連動、從下單到評分的完整訂單流程，讓經營回到該有的順手與清醒。

## 使用者功能

### User （一般使用者）

#### 使用者登入、註冊

- 註冊：使用者可以註冊帳號設定使用者名稱、電話、密碼及電子郵件信箱，系統會分配一個 user_id 給每位使用者。
- 登入：使用電話號碼登入並驗證密碼。

#### 管理個人帳號資訊

- 使用者可以修改自己的使用者名稱、密碼及電子郵件信箱。
- 使用者可以新增和修改個人常用外送地址。

#### 瀏覽特定店家的商品菜單。

- 使用者可以選擇品牌及店家，並瀏覽該店的菜單。

#### 建立訂單

- 訂單類型：使用者可以選擇自取或外送。
- 客製化：使用者可以選擇店家的特定商品與數量，並根據商家制定的規則進行客製化調整。

#### 評價訂單

- 使用者可以針對已完成的訂單及訂單商品提交評分與評論。

### Store Staff (店家員工)

除了上述 User 擁有的功能以外，還增加以下功能：

#### 管理門市資訊

- 基本資訊：修改營業時間、設定外送門檻、開啟或關閉接單狀態。
- 門市商品：設定商品販售價格與上架狀態。
- 門市選項：停用或啟用特定客製化選項（例如珍珠售完時停用該選項）。

#### 訂單查詢與管理

- 店員可以查看門市的新訂單並操作訂單狀態，包含「接受訂單」和「完成訂單」。
-  查看訂單明細及其客製化選項以便備餐。

### Brand Manager (品牌管理員)

除了上述 User 擁有的功能以外，還增加以下功能：

#### 商品管理

- 管理員可以新增、修改特定品項的資料。
- 管理員可以啟用或停用該品項。

#### 客製化選項管理

- 管理員可以新增或修改選項群組（如甜度、冰塊、加料）或特定選項的資料。
- 管理員可以啟用或停用選項群組或特定選項。
- 管理員可以綁定每個商品適用的選項群組規則（下單該商品時，至少／至多需選擇幾個選項）
- 管理員可以設定選項的互斥邏輯（例如冰沙不適用「熱飲」）

## 使用方法

### 連線方法

- 在 `db_conn.py` 設定**資料庫名稱** (DB_NAME)、**使用者名稱** (DB_USER)、**主機位置** (DB_HOST)及**通訊埠** (DB_PORT)
- 在 `./`(root) 建立 `.env`：
```env
DB_PASSWORD=你的postgre密碼
```
**⚠️不要有空格或引號**
(註：`.env` 會被 `.gitignore` 忽略，本地 postgre 密碼不會被 git 存取)

### 安裝步驟

詳細安裝說明請參考 **[INSTALLATION.md](INSTALLATION.md)**

**快速安裝命令：**

```bash
# 1. 建立資料庫並匯入 Schema
psql -U postgres -c "CREATE DATABASE databaseproject;"
psql -U postgres -d databaseproject -f schema/001_init_mod1.sql
psql -U postgres -d databaseproject -f schema/002_init_mod2.sql
psql -U postgres -d databaseproject -f schema/003_init_mod3.sql

# 2. 載入測試資料（包含自動序列修復）
psql -U postgres -d databaseproject -f reset_database.sql
psql -U postgres -d databaseproject -f test_data_new.sql

# 3. 初始化門市營業時間
python init_store_hours.py

# 4. 啟動應用程式
python main.py
```

**重要提示：** 
- ✅ `test_data_new.sql` 已包含自動序列修復功能，載入後可直接使用
- ✅ 包含 5,000 位使用者、50,000 筆訂單的完整測試資料
- ✅ 如遇到問題，請參考 [INSTALLATION.md](INSTALLATION.md) 的故障排除章節

### 操作系統

執行 `main.py` 啟動系統：

```bash
python .\main.py
```



## 技術細節

- 使用 Socket 建立 client-server 連線，搭配 Multithreading 達成多人同時連線

- 資料庫使用 PostgreSQL，使用套件 Psycopg2 對資料庫進行操作

- **交易管理**：針對 Admin 的【批次匯入課程資訊】的功能，為實現交易管理，在寫入的過程中如果
  出現違反資料表限制的情況，新增的動作會立即停止，而系統將 ROLLBACK 回滾該次交易，取消之前的所有資料庫異動。反之若匯入過程順利完成，系統將在最後 COMMIT 提交交易，確保所有的課程資訊都已成
  功儲存至資料庫。

  - 可參考 `./DB_util.py` 中的 `upload_courses()` 與 `./action/course_management/UploadCourses.py`。

- **併行控制**：針對【開設讀書會】功能，為避免不同使用者同時預約某教室的相同時段，造成資料衝突，在使用者輸入讀書會資訊並按下確認鍵後，系統會針對此功能加鎖，檢查該是否已被借用，若無則成功新增借用記錄到STUDY_EVENT_PERIOD 並且解鎖，若有則解鎖並回傳錯誤訊息，以確保教室不會被重複借用。

  - 可參考 `./DB_util.py` 中的 `create_study_group()`。

  

## 程式說明

1. **`./server.py`**
   - 包含伺服器端的主要功能。
   - 在連接資料庫後，透過 socket 建立監聽服務，接收來自客戶端的連線請求。
   - 每當接收到一個客戶端連線，會啟動一個獨立的執行緒（thread）處理該連線，確保伺服器能並行處理多個客戶端。
2. **`./client.py`**
   - 包含客戶端的主要功能。
   - 持續從伺服器接收訊息並顯示於終端機。
   - 當訊息包含特定標籤（tag）時，根據標籤執行對應的操作，例如讀取使用者輸入、解析 CSV 檔案、關閉 socket 連線並結束程式。
3. **`./DB_utils.py`**
   - 封裝與資料庫相關的功能，包含資料庫連線管理與查詢操作。
4. **`./action` 資料夾**
   - 每項執行動作被實作為一個類別，繼承抽象類別 `Action`，並實作其核心方法 `exec()`。
   - 此架構讓程式具備高度擴展性，開發者可透過新增 action 類別輕鬆增加新功能。
5. **`./role` 資料夾**
   - 為支援未來擴展更多角色類型（如 User 和 Admin 之外的角色），將角色實作為類別，並繼承基底類別 `Role`。
   - 每個角色類別共享基底類別的通用功能，並可擴展定義角色特有的行為與權限。



## 開發環境

- Windows 11

- Python: 3.10.9

  - psycopg2: 2.9.10
  - pandas: 2.2.2
  - tabulate: 0.9.0

- PostgreSQL: 16.4

  

## 參考資料

- README 說明文件及報告內容來自 **113-1資料庫管理**
